const fs=require('fs');
const path = require("path");
const tp=require('./Template');
const vl=require('./Variable');
var lc = (function(){
    var unique;
    function Construct(){
        this._dynamic=true;
        this._template='';
        this._compile='';
        this._extName='';
        this._outpath='';
        this.init=function(_path){
            if(unique._outpath){
                return;
            }
            this._outpath=_path;
            var obj=JSON.parse(fs.readFileSync(__dirname+'/config.json'));
            this._template=this._outpath+"\\"+obj['template_file'];
            this._compile=this._outpath+"\\"+obj['compile_file'];
            this._dynamic=obj['dynamic'];
            if(this._dynamic){
               this.getAllFiles(this._template,function(error,result){
                   result.forEach(function(file){
                       if(file.endsWith(unique._extName)){
                           var l=unique._extName.length;
                           var math=file.slice(0,file.length-l);
                           math=math.replace(unique._template,unique._compile);
                           tp(file,math+".js",unique._template,unique._compile,function(){
                               try{require(math);}catch (e){console.log(e);}
                           });
                           var listen=(function () {
                               return function(){
                                   console.log("文件" + file + " 内容刚刚改变" );
                                   tp(file,math+".js",unique._template,unique._compile,function(){});
                                   delete require.cache[require.resolve(math)];
                               };
                           })();
                           fs.watch(file,listen);
                       }
                   });
               });
            }
            this._extName=obj['extName'];
            MD(this._template,'0777',function(e){if(e)console.log(e);});
            MD(this._compile,'0777',function(e){if(e)console.log(e);});
            function MD(dirPath, mode, callback){
                fs.exists(dirPath, function (exists){
                    if(!exists){
                        MD(path.dirname(dirPath), mode, function (){
                            fs.mkdir(dirPath, mode, callback);
                        });
                    }else{
                        callback();
                    }
                });
            }
        };
        this.display=function(file,callback){
            file=unique._template+"/"+file;
            var math=file.replace(unique._template,unique._compile);
            var l=unique._extName.length;
            math=math.slice(0,math.length-l);
            try{
                var D=require(math);
                callback(D);
            }catch(e){
                console.log(e);
            }
        };
        this.getValObj=function(){
            return new vl();
        };
        this.getAllFiles=function(dir, done) {
            var results = [];
            fs.readdir(dir, function(err, list) {
                if (err) return done(err);
                var pending = list.length;
                if (!pending) return done(null, results);
                list.forEach(function(file) {
                    file = path.resolve(dir, file);
                    fs.stat(file, function(err, stat) {
                        if (stat && stat.isDirectory()) {
                            walk(file, function(err, res) {
                                results = results.concat(res);
                                if (!--pending) done(null, results);
                            });
                        } else {
                            results.push(file);
                            if (!--pending) done(null, results);
                        }
                    });
                });
            });
        };
    }
    unique = new Construct();
    return unique;
})();
module.exports=lc;